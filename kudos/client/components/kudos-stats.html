<dom-module id="kudos-stats">
<link rel="import" href="../css/kudo-style.html">
<template id="tmpkudoStats">
 <style include="cards"></style>
 <style include="stats"></style>
  <div class="card">
    <h3>Results of the event</h3>
  </div>
  <paper-tabs selected="{{selected}}">
    <paper-tab on-click="closeKudoStats">Assessment</paper-tab>
    <paper-tab on-click="getRanking">Gratefulness</paper-tab>
  </paper-tabs>

  <iron-pages selected="{{selected}}">
    <div class="resultFeedback">
      <div id="id_admin_vote" on-click="_updateActiveVote" class='power_base' style="display:none;">&nbsp;</div>
      
      <template is="dom-if" if="{{withStars}}">
        <paper-card class="paper_card_summary">
          <div class="rate-header titleProject title_summary_div" on-click="unCollapse" data-selector="#blockRating">
              <div class="display_inline"><img style="width:50%" src="../images/copa.png" data-selector="#blockRating"></div>
              <div class="display_inline title_summary" data-selector="#blockRating">
                &gt; Ranking general por estrellas
              </div>
          </div>
          <iron-collapse id="blockRating" style="width:100%;">
              <div style="width:100%;background: #ecd878;font-weight: bold;" class="row_table_bottom">
                <div class="display_inline" style="width:8%;">
                  &nbsp;
                </div>
                <div class="display_inline" style="width:10%;">
                  Jur.
                </div>
                <div class="display_inline" style="width:10%;">
                  PÃºb.
                </div>
                <div class="display_inline" style="width:10%;">
                  Tot.
                </div>
                <div class="display_inline" style="width:55%;">
                  Feature
                </div>
              </div>
            <template id="listRating"  is="dom-repeat" items="{{sortedRating}}" as="sortCard">
              <div class="row_table_bottom" style="width:100%;">
                <div style="width:100%;">
                  <div class="display_inline" style="width:8%">
                    <img src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCA1MTEuOTk5IDUxMS45OTkiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDUxMS45OTkgNTExLjk5OTsiIHhtbDpzcGFjZT0icHJlc2VydmUiIHdpZHRoPSIyNHB4IiBoZWlnaHQ9IjI0cHgiPgo8Zz4KCTxnPgoJCTxwYXRoIGQ9Ik00NjYuNDUsNDkuMzc0Yy03LjA2NS04LjMwOC0xNy4zNjgtMTMuMDcxLTI4LjI2Ny0xMy4wNzFINDAyLjQxdi0xMS4xOUM0MDIuNDEsMTEuMjY2LDM5MS4xNDMsMCwzNzcuMjk3LDBIMTM0LjcwNSAgICBjLTEzLjg0OCwwLTI1LjExMiwxMS4yNjYtMjUuMTEyLDI1LjExMnYxMS4xOUg3My44MTZjLTEwLjg5OSwwLTIxLjIwMyw0Ljc2NC0yOC4yNjcsMTMuMDcxICAgIGMtNi45OTIsOC4yMjEtMTAuMDE0LDE5LjAxOS04LjI4OSwyOS42MjRjOS40LDU3LjgsNDUuNzc1LDEwOC44NjMsOTcuNCwxMzYuODcyYzQuNzE3LDExLjM0MSwxMC4wNTksMjIuMDgzLDE2LjAwOCwzMi4wOTEgICAgYzE5LjAwMiwzMS45NzUsNDIuNjI1LDU0LjA3Myw2OC42MjcsNjQuNzZjMi42MzUsMjYuNjQ0LTE1LjA5NCw1MS44ODUtNDEuNzk0LDU3LjljLTAuMDU3LDAuMDEzLTAuMDk3LDAuMDMzLTAuMTUzLDAuMDQ2ICAgIGMtNS4yMTEsMS4yNDUtOS4wOSw1LjkyMS05LjA5LDExLjUxM3Y1NC4zNjNoLTIxLjk4NmMtMTkuNjAyLDAtMzUuNTQ5LDE1Ljk0Ny0zNS41NDksMzUuNTQ5djI4LjA1OCAgICBjMCw2LjU0NSw1LjMwNSwxMS44NSwxMS44NSwxMS44NUgzOTAuNTZjNi41NDUsMCwxMS44NS01LjMwNSwxMS44NS0xMS44NXYtMjguMDU4YzAtMTkuNjAyLTE1Ljk0Ny0zNS41NDktMzUuNTQ5LTM1LjU0OWgtMjEuOTg4ICAgIFYzODIuMThjMC01LjYwMy0zLjg5My0xMC4yODYtOS4xMTgtMTEuNTJjLTAuMDQ5LTAuMDEyLTAuMDk2LTAuMDI4LTAuMTQ1LTAuMDRjLTI2LjkwMi02LjA1NS00NC42NjQtMzEuNTUtNDEuNzUyLTU4LjM5NCAgICBjMjUuNTQ4LTEwLjg2LDQ4Ljc1Ny0zMi43NjEsNjcuNDc5LTY0LjI2NGM1Ljk0OS0xMC4wMDksMTEuMjktMjAuNzUyLDE2LjAwOC0zMi4wOTVjNTEuNjIyLTI4LjAxLDg3Ljk5NS03OS4wNzIsOTcuMzk1LTEzNi44NyAgICBDNDc2LjQ2NSw2OC4zOTIsNDczLjQ0Myw1Ny41OTUsNDY2LjQ1LDQ5LjM3NHogTTYwLjY1Miw3NS4xOTJjLTAuNjE2LTMuNzg3LDAuNDMxLTcuNTA0LDIuOTQ5LTEwLjQ2NiAgICBjMi41NTUtMy4wMDQsNi4yNzctNC43MjYsMTAuMjE0LTQuNzI2aDM1Ljc3N3YyMS44MDJjMCwzNC4xODYsNC4zNjMsNjcuMywxMi42MzIsOTcuNTgzICAgIEM4OS43MjgsMTUzLjcwNiw2Ny4zNTQsMTE2LjQwMyw2MC42NTIsNzUuMTkyeiBNMzY2Ljg2MSw0NjAuMjQzYzYuNTM0LDAsMTEuODUsNS4zMTYsMTEuODUsMTEuODV2MTYuMjA4SDEzNC40MjJ2LTE2LjIwOCAgICBjMC02LjUzNCw1LjMxNi0xMS44NSwxMS44NS0xMS44NUgzNjYuODYxeiBNMzIxLjE3MywzOTQuMDN2NDIuNTEzSDE5MS45NlYzOTQuMDNIMzIxLjE3M3ogTTIyMy4wMzcsMzcwLjMzMSAgICBjMi45MjktMy4yMjQsNS42MDctNi43MTksOC4wMDItMTAuNDZjNy44OTctMTIuMzM5LDEyLjA0Mi0yNi4zNTcsMTIuMjI4LTQwLjY3NGM0LjIwOSwwLjU3Myw4LjQ1NywwLjg4LDEyLjc0MSwwLjg4ICAgIGM0LjY2MSwwLDkuMjc5LTAuMzU4LDEzLjg1Mi0xLjAzNmMwLjI3LDE5LjIzOSw3Ljc1OCwzNy40NSwyMC4zNDksNTEuMjg5SDIyMy4wMzd6IE0zNzguNzA5LDgxLjgwMyAgICBjMCw1OC4zNzktMTMuNDA2LDExMy4wODktMzcuNzQ3LDE1NC4wNDljLTIzLjE5MiwzOS4wMy01My4zNjQsNjAuNTI1LTg0Ljk1Niw2MC41MjVjLTMxLjU5NywwLTYxLjc3MS0yMS40OTQtODQuOTY2LTYwLjUyMyAgICBjLTI0LjM0Mi00MC45NjEtMzcuNzQ4LTk1LjY3MS0zNy43NDgtMTU0LjA0OVYyNS4xMTJjMC0wLjc4LDAuNjM0LTEuNDEzLDEuNDEyLTEuNDEzaDI0Mi41OTFjMC43OCwwLDEuNDE0LDAuNjM0LDEuNDE0LDEuNDEzICAgIFY4MS44MDN6IE00NTEuMzQ4LDc1LjE5MmMtNi43MDIsNDEuMjA4LTI5LjA3NCw3OC41MS02MS41NjksMTA0LjE5MWM4LjI2OC0zMC4yODMsMTIuNjMxLTYzLjM5NSwxMi42MzEtOTcuNThWNjAuMDAxaDM1Ljc3MyAgICBjMy45MzgsMCw3LjY2LDEuNzIzLDEwLjIxNCw0LjcyNkM0NTAuOTE1LDY3LjY4OCw0NTEuOTYzLDcxLjQwNSw0NTEuMzQ4LDc1LjE5MnoiIGZpbGw9IiNGRkRBNDQiLz4KCTwvZz4KPC9nPgo8Zz4KCTxnPgoJCTxwYXRoIGQ9Ik0zMjcuOTQxLDEyMS42NThjLTEuMzk1LTQuMjg4LTUuMTAzLTcuNDE0LTkuNTY2LTguMDY0bC0zNS43NTgtNS4xOTZsLTE1Ljk5MS0zMi40MDIgICAgYy0xLjk5Ny00LjA0NC02LjExNi02LjYwNS0xMC42MjYtNi42MDVjLTQuNTExLDAtOC42MywyLjU2MS0xMC42MjYsNi42MDVsLTE1Ljk5MSwzMi40MDJsLTM1Ljc1OCw1LjE5NiAgICBjLTQuNDY0LDAuNjQ4LTguMTcyLDMuNzc1LTkuNTY2LDguMDY1Yy0xLjM5Myw0LjI5MS0wLjIzMSw4Ljk5OSwyLjk5OSwxMi4xNDhsMjUuODc1LDI1LjIyMWwtNi4xMDksMzUuNjEzICAgIGMtMC43NjMsNC40NDYsMS4wNjQsOC45MzgsNC43MTQsMTEuNTljMy42NDgsMi42NTEsOC40ODcsMywxMi40NzksMC45MDJMMjU2LDE5MC4zMmwzMS45ODIsMTYuODEzICAgIGMxLjczNCwwLjkxMSwzLjYyNywxLjM2LDUuNTEyLDEuMzZjMi40NTYsMCw0LjkwMi0wLjc2Myw2Ljk2Ni0yLjI2M2MzLjY1LTIuNjUyLDUuNDc3LTcuMTQ0LDQuNzE0LTExLjU5bC02LjEwOS0zNS42MTMgICAgbDI1Ljg3NS0yNS4yMjFDMzI4LjE3MiwxMzAuNjU4LDMyOS4zMzQsMTI1Ljk0OSwzMjcuOTQxLDEyMS42NTh6IE0yNzguMDY0LDE0Ni40MDVjLTIuNzkzLDIuNzIyLTQuMDY4LDYuNjQ0LTMuNDA4LDEwLjQ4OSAgICBsMy4xMDIsMTguMDlsLTE2LjI0NS04LjU0MWMtMS43MjUtMC45MDgtMy42Mi0xLjM2LTUuNTE0LTEuMzZjLTEuODk0LDAtMy43ODgsMC40NTQtNS41MTQsMS4zNmwtMTYuMjQ1LDguNTQxbDMuMTAyLTE4LjA5ICAgIGMwLjY2LTMuODQ0LTAuNjE1LTcuNzY2LTMuNDA4LTEwLjQ4OWwtMTMuMTQxLTEyLjgxbDE4LjE2Mi0yLjY0YzMuODU5LTAuNTYsNy4xOTYtMi45ODUsOC45MjItNi40ODJsOC4xMjMtMTYuNDU4bDguMTIyLDE2LjQ1OCAgICBjMS43MjcsMy40OTcsNS4wNjIsNS45MjEsOC45MjIsNi40ODJsMTguMTYyLDIuNjRMMjc4LjA2NCwxNDYuNDA1eiIgZmlsbD0iI0ZGREE0NCIvPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=" />
                  </div> 
                  <div class="display_inline" style="width:10%;text-align:right;">
                    {{sortCard.averagePublic}}  
                  </div>
                  <div class="display_inline" style="width:10%;text-align:right;">
                    {{sortCard.averageRating}}  
                  </div>
                  <div class="display_inline" style="vertical-align:middle;width:55%;text-align: left;padding-left:5px;"> 
                    {{sortCard.title}}<br>
                  </div>
                </div>
              </div>
            </template>
          </iron-collapse>
        </paper-card>
      </template>
      
      
      <template is="dom-if" if="{{withKudos}}">
        <template is="dom-repeat" items="{{kudos}}" as="kudo">
          <kudos-positions-table id="stat_{{kudo.id}}" active-event='{{activeEvent}}' kudo='{{kudo}}' id-kudo='{{kudo.id}}' with-exclusive-kudo='{{withExclusiveKudo}}' with-jury='{{withJury}}' members-jury='{{membersJury}}' cards-kudo='{{cards}}' ></kudos-positions-table>
        </template>
      </template>
      
    </div>

    <div class="resultFeedback">
      <h3>Ranking of users</h3>
      <span id="numUsers">(Number of users: {{numUsers}})</span>
      <template is="dom-repeat" items="[[users]]" as="user" id="rankingComments">
        <div>
          <div class="personItem" tabindex$="[[tabIndex]]">
            <iron-image class="avatar" sizing="contain" src="[[user.picture]]"></iron-image>
            <div class="pad">
              <div><b style="font-size: 12px;">[[user.name]]</b></div>
              <address>
                <template is="dom-if" if="{{withFeedback}}">
                  <div class="inline-block">Feedbacks: [[user.numFeedBack]]</div>
                </template>
              </address>
            </div>
          </div>
        </div>
      </template>
    </div>
  </iron-pages>
</template>
<script>
 Polymer({
    is: 'kudos-stats',
    properties: {
      activeEvent   : { type: String, notify:true },
      cards         : { type: Array, notify:true },
      kudos         : { type: Array, notify:true },
      users         : { type: Array, notify:true },
      numUsers      : { type: String, notify:true },
      selected      : { value: 0 },
      display       : { value: "block" },
      sortedRating  : { type: Array, notify:true },
      
      membersJury   : { type: String, notify:true },
      withJury      : { type: Boolean, value:false, notify:true},
      
      withExclusiveKudo:{type: Boolean, value:false, notify:true},
      withKudos     : { type: Boolean, value:false, notify:true},
      withFeedback  : { type: Boolean, value:false, notify:true},
      withStars     : { type: Boolean, value:false, notify:true},
      
      activeVotes     : {type: Boolean, value:false, notify:true},
      isAdmin         : {type: Boolean, value:false, notify:true},
    },
    getKudos:function(){
      var self = this;
      firebase.database().ref(this.activeEvent + '/kudos').once('value').then(function(snapshot) {
        self.kudos = [];
        snapshot.forEach(function(child) {
          var kudo = child.val();
          kudo.id=child.key;
          self.push('kudos', kudo);
        });
        });
    },
    getBlocks:function(){
      var ref = firebase.database().ref(this.activeEvent + "/blocks");
      var self = this;
      self.cards=[];
      ref.once("value").then(function(snapshot) {
        self.blocks = [];
        snapshot.forEach(function(child) {
          var block = child.val();
          block.id  = child.key;
          self.push('blocks', block);
          for (var idCard in block.cards) {
            var card=block.cards[idCard];
            card.idCard     = idCard;
            card.titleBlock = block.title;
            self.push('cards', card);
          }
        });
      });
    },
    compareValues:function(key, order='asc') {
      return function(a, b) {
        if(!a.hasOwnProperty(key) || 
           !b.hasOwnProperty(key)) {
      	  return 0; 
        }
        
        const varA = (typeof a[key] === 'string') ? 
          a[key].toUpperCase() : a[key];
        const varB = (typeof b[key] === 'string') ? 
          b[key].toUpperCase() : b[key];
          
        let comparison = 0;
        if (varA > varB) {
          comparison = 1;
        } else if (varA < varB) {
          comparison = -1;
        }
        return (
          (order == 'desc') ? 
          (comparison * -1) : comparison
        );
      };
    },
    closeKudoStats:function(){
      for(var kudo of this.kudos){
        this.$$('#stat_'+kudo.id).closeTable();
      }
    },
    getRanking:function(){
      var self=this;
      for(var user of this.users){
        var numFeedBack=0;
        firebase.database().ref(self.activeEvent +'/trackingUserComments/'+user.uid).once('value',function(snapshot) {
          var posts=snapshot.val();
          if (posts){
              numFeedBack=Object.keys(posts).length;
              self.users.find(function(currentValue, index, arr) {
              if(currentValue.uid === snapshot.key){
                currentValue.numFeedBack=numFeedBack;
                self.users.sort(function(a,b) {
                  return (a.numFeedBack > b.numFeedBack) ? -1 : ((b.numFeedBack > a.numFeedBack) ? 1 : 0);} );
                self.$$('#rankingComments').render();
              }
              });
          }
        });
      }

    },
    getUsers:function() {
      var self=this;
      this.closeKudoStats();
      firebase.database().ref(this.activeEvent +'/users').once('value',function(snapshot) {
        var users = snapshot.val();
        var numUsers=0;
        self.users=[];
        for (var user in users) {
          var _user={};
          numUsers++;
          _user.uid        = users[user].profile.uid;
          _user.name        = users[user].profile.name;
          _user.picture     = users[user].profile.picture;
          _user.numFeedBack = 0;
          self.push('users',_user);
        }
        self.numUsers=numUsers;
      });
    },
    unCollapse: function(e) {
      if(e.target.dataset.selector!='undefined'){
        this.$$(e.target.dataset.selector).toggle();  
      }
    },
    verifyAdmin:function(){
      var idBtnVote=this.$$('#id_admin_vote');
      idBtnVote.style.display = "none";
      if(this.isAdmin){
        idBtnVote.style.display = "inline-block";
        this.verifyActiveVote();
      }
      
    },
    verifyActiveVote:function(){
      var idBtnVote=this.$$('#id_admin_vote');
      var BtnVoteEnable=idBtnVote.classList.contains('kudo_enable');
      if(BtnVoteEnable){
        idBtnVote.classList.remove("kudo_enable");  
      }
      if(this.activeVotes){
        idBtnVote.classList.add("kudo_enable");  
      }else{
        idBtnVote.classList.remove("kudo_enable");  
      }
      
    },
    _updateActiveVote:function(){
      var refControl = firebase.database().ref(this.activeEvent +'/attributes');
      var btnActiveVotes=this.$$('#id_admin_vote');
      var classActiveVotes=btnActiveVotes.classList.contains('kudo_enable');
      var update = {};
      var _activeVotes=false;
      if(!classActiveVotes) {
        btnActiveVotes.classList.add("kudo_enable");
        _activeVotes=true;
      }else{
        btnActiveVotes.classList.remove("kudo_enable");
      }
      update["activeVotes"]=_activeVotes;
      refControl.update(update);
    }
  });
</script>
</dom-module>
