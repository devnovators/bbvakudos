<dom-module id="star-positions-table">
<link rel="import" href="../css/kudo-style.html">
<template>
    <style include="about-estilo"></style>
    <style include="cards"></style>
        <paper-card class="paper_card_summary">
          <div class="rate-header titleProject title_summary_div" on-click="unCollapse" data-selector="#blockRanking">
              <div class="display_inline"><img src="../images/aplauso.png" data-selector="#blockRanking"></div>
              <div class="display_inline title_summary" data-selector="#blockRanking">Reconocimiento por estrellas</div>
          </div>
          <iron-collapse id="blockRanking" style="width:100%;">
            <div id="tableRanking"></div>
          </iron-collapse>
        </paper-card>
</template>

<script>
 Polymer({
    is: 'star-positions-table',
    properties: {
      activeEvent       : { type: String,   notify:true},
      membersJury       : { type: String,   notify:true },
      withJury          : { type: Boolean,  value:false,  notify:true},
      cardsStar         : { type: Array,    value:[],     notify:true},
      sortedArray       : { type: Array,    notify:true},
    },
    ready:function(){
      //this.getRanking();  
    },
    getRankingStar:function(){
        var self = this;
        self.sortedArray=[];
        for(var card of this.cardsStar){
          var _basicCard=card;
          _basicCard.qtyStar=0;
          _basicCard.perStar=0;
          _basicCard.qtyJury=0;
          _basicCard.perJury=0;
          _basicCard.total=0;
          self.push('sortedArray',_basicCard);
        }
        if(this.withJury){
          this.getRankingJury();
        }else{
          this.getRankingBasic();
        }
    },
    getRankingBasic:function(){
      var refSelect;
      var self = this;
      refSelect = firebase.database().ref(this.activeEvent + "/logStars");
      refSelect.once('value').then(function(snapshot) {
        snapshot.forEach(function(child) {
          console.info('Feature: ' + child.key);
          var votes=child.val();
          self.sortedArray.find(function(currentValue, index, arr) {
            if(currentValue.idCard === child.key){
              for(var vote in votes){
                currentValue.total=currentValue.total+votes[vote];
                console.info(votes[vote]);
                console.info('--------------');
              }
            }
          });
        });
        self.sortedArray.sort(self.compareValues('total','desc'));
        self.createTable();
      });
    },
    getRankingJury:function(){
      var refSelect;
      var self = this;
      
      var _juryMembers=[];
      var _totalJuryMembers=0;
      _juryMembers=self.membersJury.toString().split(";");
      _totalJuryMembers=_juryMembers.length;
      
      refSelect = firebase.database().ref(this.activeEvent + "/logStars");
      refSelect.once('value').then(function(snapshot) {
        var totalVoters=0;
        //console.log(snapshot.numChildren());
        totalVoters=snapshot.numChildren();
        snapshot.forEach(function(child) {
          self.sortedArray.find(function(currentValue, index, arr) {
            var _total=0.0;
            if(currentValue.idCard === child.val()){
              //console.info(child.key);
              var lista=self.membersJury.toString().replace(/[@.]/g,'_');
              var tipo = lista.indexOf(child.key);
              if(tipo<0){
                currentValue.qtyStar++;
              }else{
                currentValue.qtyJury++;
              }
              totalVoters=totalVoters-currentValue.qtyJury;
              if(totalVoters==0){
                currentValue.perStar=0;
              }else{
                currentValue.perStar=((50/totalVoters)*currentValue.qtyStar);  
              }
              if(currentValue.qtyJury==0){
              
                currentValue.qtyJury=0;
              }else{
                currentValue.perJury=((50/_totalJuryMembers)*currentValue.qtyJury);  
              }
              
              _total=(currentValue.perJury+currentValue.perStar);
              
              //currentValue.perStar=currentValue.perStar.toFixed(2);
              //currentValue.perJury=currentValue.perJury.toFixed(2);
              var _total_float=parseFloat(_total.toFixed(2));
              currentValue.total=_total_float;
            }
          });
        });
        self.sortedArray.sort(self.compareValues('total','desc'));
        self.createTableJury();
      });
    },
    compareValues:function(key, order='asc') {
      return function(a, b) {
        if(!a.hasOwnProperty(key) || 
           !b.hasOwnProperty(key)) {
      	  return 0; 
        }
        
        const varA = (typeof a[key] === 'string') ? 
          a[key].toUpperCase() : a[key];
        const varB = (typeof b[key] === 'string') ? 
          b[key].toUpperCase() : b[key];
          
        let comparison = 0;
        if (varA > varB) {
          comparison = 1;
        } else if (varA < varB) {
          comparison = -1;
        }
        return (
          (order == 'desc') ? 
          (comparison * -1) : comparison
        );
      };
    },
    closeTable:function(){
      if(this.$.blockRanking.opened){
        this.$.blockRanking.toggle();
      }
    },
    unCollapse: function(e) {
      this.$.blockRanking.toggle();
      if(this.$.blockRanking.opened){
        this.getRankingStar();  
      }
    },
    createTable:function(){
      var item="";
      var head_start='';
      var head_mid='';
      var head_end='';
      
      head_start = '<div class="row_table_bottom"><div class="row_table_cup"><img src="../images/values_cup.jpg" /></div><div class="row_table_qty">';
      head_mid   = '</div><div class="row_table_detail">';
      head_end   = '</div></div></div>';
      this.$.tableRanking.innerHTML="";
      
      for(var card of this.sortedArray){
        item=head_start + card.total + head_mid + card.titleBlock +" &gt " + card.title + head_end;
        this.$.tableRanking.innerHTML=this.$.tableRanking.innerHTML+item;
      }
    },
    createTableJury:function(){
      var item="";
      var head_start='';
      var head_mid='';
      var head_end='';
      var head_col_ini='';
      var head_col_fin='';
      
      head_start = '<div class="row_table_bottom"><div class="row_table_cup"><img src="../images/values_cup.jpg" /></div><div class="row_table_qty">';
      head_col_ini='<div class="row_table_qty">';
      head_col_fin='</div>';
      head_mid   = '</div><div class="row_table_detail">';
      head_end   = '</div></div></div>';
      this.$.tableRanking.innerHTML="";
      
      for(var card of this.sortedArray){
        //console.info('Item: '+ card.title);
        //console.info('| perJury==> ' + card.perJury +'| qtyJury==> ' + card.qtyJury);
        //console.info('| perStar==> ' + card.perStar +'| qtyStar==> ' + card.qtyStar);
        item=head_start + card.total + '%' + head_mid + card.titleBlock +" &gt " + card.title + head_end;
        this.$.tableRanking.innerHTML=this.$.tableRanking.innerHTML+item;
      }
    },
  });
</script>
</dom-module>
