<dom-module id="kudos-positions-table">
<link rel="import" href="../css/kudo-style.html">
<template>
    <style include="about-estilo"></style>
    <style include="cards"></style>
    <paper-card class="paper_card_summary">
      <div class="rate-header titleProject" style="height:70px;background:#2dcccd;" on-click="unCollapseTable" data-selector="#blockKudoStat_{{idKudo}}">
          <div class="display_inline kudo_base" style$='background-image: url({{kudo.icon}});'  data-selector="#blockKudoStat_{{idKudo}}"></div>
          <div class="display_inline" width="70%" style="top: 40%;transform: translateY(-90%);font-weight:bolder;color:#fff!important;" data-selector="#blockKudoStat_{{idKudo}}">
            {{kudo.title}}
          </div>
      </div>
      <iron-collapse id="blockKudoStat_{{idKudo}}" style="width:100%;">
        <template is="dom-repeat" items="{{sortedArray}}" as="sortCard" id="ranking_{{idKudo}}">
          <div width="100%" style="text-align:left !important;margin-top:3px;">
            <div style="display:inline-block;width:5%">
              <img src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCA1MTEuOTk5IDUxMS45OTkiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDUxMS45OTkgNTExLjk5OTsiIHhtbDpzcGFjZT0icHJlc2VydmUiIHdpZHRoPSIyNHB4IiBoZWlnaHQ9IjI0cHgiPgo8Zz4KCTxnPgoJCTxwYXRoIGQ9Ik00NjYuNDUsNDkuMzc0Yy03LjA2NS04LjMwOC0xNy4zNjgtMTMuMDcxLTI4LjI2Ny0xMy4wNzFINDAyLjQxdi0xMS4xOUM0MDIuNDEsMTEuMjY2LDM5MS4xNDMsMCwzNzcuMjk3LDBIMTM0LjcwNSAgICBjLTEzLjg0OCwwLTI1LjExMiwxMS4yNjYtMjUuMTEyLDI1LjExMnYxMS4xOUg3My44MTZjLTEwLjg5OSwwLTIxLjIwMyw0Ljc2NC0yOC4yNjcsMTMuMDcxICAgIGMtNi45OTIsOC4yMjEtMTAuMDE0LDE5LjAxOS04LjI4OSwyOS42MjRjOS40LDU3LjgsNDUuNzc1LDEwOC44NjMsOTcuNCwxMzYuODcyYzQuNzE3LDExLjM0MSwxMC4wNTksMjIuMDgzLDE2LjAwOCwzMi4wOTEgICAgYzE5LjAwMiwzMS45NzUsNDIuNjI1LDU0LjA3Myw2OC42MjcsNjQuNzZjMi42MzUsMjYuNjQ0LTE1LjA5NCw1MS44ODUtNDEuNzk0LDU3LjljLTAuMDU3LDAuMDEzLTAuMDk3LDAuMDMzLTAuMTUzLDAuMDQ2ICAgIGMtNS4yMTEsMS4yNDUtOS4wOSw1LjkyMS05LjA5LDExLjUxM3Y1NC4zNjNoLTIxLjk4NmMtMTkuNjAyLDAtMzUuNTQ5LDE1Ljk0Ny0zNS41NDksMzUuNTQ5djI4LjA1OCAgICBjMCw2LjU0NSw1LjMwNSwxMS44NSwxMS44NSwxMS44NUgzOTAuNTZjNi41NDUsMCwxMS44NS01LjMwNSwxMS44NS0xMS44NXYtMjguMDU4YzAtMTkuNjAyLTE1Ljk0Ny0zNS41NDktMzUuNTQ5LTM1LjU0OWgtMjEuOTg4ICAgIFYzODIuMThjMC01LjYwMy0zLjg5My0xMC4yODYtOS4xMTgtMTEuNTJjLTAuMDQ5LTAuMDEyLTAuMDk2LTAuMDI4LTAuMTQ1LTAuMDRjLTI2LjkwMi02LjA1NS00NC42NjQtMzEuNTUtNDEuNzUyLTU4LjM5NCAgICBjMjUuNTQ4LTEwLjg2LDQ4Ljc1Ny0zMi43NjEsNjcuNDc5LTY0LjI2NGM1Ljk0OS0xMC4wMDksMTEuMjktMjAuNzUyLDE2LjAwOC0zMi4wOTVjNTEuNjIyLTI4LjAxLDg3Ljk5NS03OS4wNzIsOTcuMzk1LTEzNi44NyAgICBDNDc2LjQ2NSw2OC4zOTIsNDczLjQ0Myw1Ny41OTUsNDY2LjQ1LDQ5LjM3NHogTTYwLjY1Miw3NS4xOTJjLTAuNjE2LTMuNzg3LDAuNDMxLTcuNTA0LDIuOTQ5LTEwLjQ2NiAgICBjMi41NTUtMy4wMDQsNi4yNzctNC43MjYsMTAuMjE0LTQuNzI2aDM1Ljc3N3YyMS44MDJjMCwzNC4xODYsNC4zNjMsNjcuMywxMi42MzIsOTcuNTgzICAgIEM4OS43MjgsMTUzLjcwNiw2Ny4zNTQsMTE2LjQwMyw2MC42NTIsNzUuMTkyeiBNMzY2Ljg2MSw0NjAuMjQzYzYuNTM0LDAsMTEuODUsNS4zMTYsMTEuODUsMTEuODV2MTYuMjA4SDEzNC40MjJ2LTE2LjIwOCAgICBjMC02LjUzNCw1LjMxNi0xMS44NSwxMS44NS0xMS44NUgzNjYuODYxeiBNMzIxLjE3MywzOTQuMDN2NDIuNTEzSDE5MS45NlYzOTQuMDNIMzIxLjE3M3ogTTIyMy4wMzcsMzcwLjMzMSAgICBjMi45MjktMy4yMjQsNS42MDctNi43MTksOC4wMDItMTAuNDZjNy44OTctMTIuMzM5LDEyLjA0Mi0yNi4zNTcsMTIuMjI4LTQwLjY3NGM0LjIwOSwwLjU3Myw4LjQ1NywwLjg4LDEyLjc0MSwwLjg4ICAgIGM0LjY2MSwwLDkuMjc5LTAuMzU4LDEzLjg1Mi0xLjAzNmMwLjI3LDE5LjIzOSw3Ljc1OCwzNy40NSwyMC4zNDksNTEuMjg5SDIyMy4wMzd6IE0zNzguNzA5LDgxLjgwMyAgICBjMCw1OC4zNzktMTMuNDA2LDExMy4wODktMzcuNzQ3LDE1NC4wNDljLTIzLjE5MiwzOS4wMy01My4zNjQsNjAuNTI1LTg0Ljk1Niw2MC41MjVjLTMxLjU5NywwLTYxLjc3MS0yMS40OTQtODQuOTY2LTYwLjUyMyAgICBjLTI0LjM0Mi00MC45NjEtMzcuNzQ4LTk1LjY3MS0zNy43NDgtMTU0LjA0OVYyNS4xMTJjMC0wLjc4LDAuNjM0LTEuNDEzLDEuNDEyLTEuNDEzaDI0Mi41OTFjMC43OCwwLDEuNDE0LDAuNjM0LDEuNDE0LDEuNDEzICAgIFY4MS44MDN6IE00NTEuMzQ4LDc1LjE5MmMtNi43MDIsNDEuMjA4LTI5LjA3NCw3OC41MS02MS41NjksMTA0LjE5MWM4LjI2OC0zMC4yODMsMTIuNjMxLTYzLjM5NSwxMi42MzEtOTcuNThWNjAuMDAxaDM1Ljc3MyAgICBjMy45MzgsMCw3LjY2LDEuNzIzLDEwLjIxNCw0LjcyNkM0NTAuOTE1LDY3LjY4OCw0NTEuOTYzLDcxLjQwNSw0NTEuMzQ4LDc1LjE5MnoiIGZpbGw9IiNGRkRBNDQiLz4KCTwvZz4KPC9nPgo8Zz4KCTxnPgoJCTxwYXRoIGQ9Ik0zMjcuOTQxLDEyMS42NThjLTEuMzk1LTQuMjg4LTUuMTAzLTcuNDE0LTkuNTY2LTguMDY0bC0zNS43NTgtNS4xOTZsLTE1Ljk5MS0zMi40MDIgICAgYy0xLjk5Ny00LjA0NC02LjExNi02LjYwNS0xMC42MjYtNi42MDVjLTQuNTExLDAtOC42MywyLjU2MS0xMC42MjYsNi42MDVsLTE1Ljk5MSwzMi40MDJsLTM1Ljc1OCw1LjE5NiAgICBjLTQuNDY0LDAuNjQ4LTguMTcyLDMuNzc1LTkuNTY2LDguMDY1Yy0xLjM5Myw0LjI5MS0wLjIzMSw4Ljk5OSwyLjk5OSwxMi4xNDhsMjUuODc1LDI1LjIyMWwtNi4xMDksMzUuNjEzICAgIGMtMC43NjMsNC40NDYsMS4wNjQsOC45MzgsNC43MTQsMTEuNTljMy42NDgsMi42NTEsOC40ODcsMywxMi40NzksMC45MDJMMjU2LDE5MC4zMmwzMS45ODIsMTYuODEzICAgIGMxLjczNCwwLjkxMSwzLjYyNywxLjM2LDUuNTEyLDEuMzZjMi40NTYsMCw0LjkwMi0wLjc2Myw2Ljk2Ni0yLjI2M2MzLjY1LTIuNjUyLDUuNDc3LTcuMTQ0LDQuNzE0LTExLjU5bC02LjEwOS0zNS42MTMgICAgbDI1Ljg3NS0yNS4yMjFDMzI4LjE3MiwxMzAuNjU4LDMyOS4zMzQsMTI1Ljk0OSwzMjcuOTQxLDEyMS42NTh6IE0yNzguMDY0LDE0Ni40MDVjLTIuNzkzLDIuNzIyLTQuMDY4LDYuNjQ0LTMuNDA4LDEwLjQ4OSAgICBsMy4xMDIsMTguMDlsLTE2LjI0NS04LjU0MWMtMS43MjUtMC45MDgtMy42Mi0xLjM2LTUuNTE0LTEuMzZjLTEuODk0LDAtMy43ODgsMC40NTQtNS41MTQsMS4zNmwtMTYuMjQ1LDguNTQxbDMuMTAyLTE4LjA5ICAgIGMwLjY2LTMuODQ0LTAuNjE1LTcuNzY2LTMuNDA4LTEwLjQ4OWwtMTMuMTQxLTEyLjgxbDE4LjE2Mi0yLjY0YzMuODU5LTAuNTYsNy4xOTYtMi45ODUsOC45MjItNi40ODJsOC4xMjMtMTYuNDU4bDguMTIyLDE2LjQ1OCAgICBjMS43MjcsMy40OTcsNS4wNjIsNS45MjEsOC45MjIsNi40ODJsMTguMTYyLDIuNjRMMjc4LjA2NCwxNDYuNDA1eiIgZmlsbD0iI0ZGREE0NCIvPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=" />
            </div> 
            <div style="display:inline-block;width:10%;text-align:right;">
              {{sortCard.qtyKudo}}  
            </div>
            
            <div style="vertical-align:middle;display:inline-block;width:70%;padding-left:10px;">  &gt; {{sortCard.titleBlock}} &gt; {{sortCard.title}}</div>
          </div>
        </template>
      </iron-collapse>
      </paper-card>
</template>

<script>
 Polymer({
    is: 'kudos-positions-table',
    properties: {
      activeEvent       : { type: String,   notify:true},
      withExclusiveKudo : { type: Boolean,  value:false, notify:true},
      cardsKudo         : { type: Array},
      sortedArray       : { type: Array,    notify:true},
      kudo              : { type: Object,   notify:true},
      idKudo            : { type: String,   notify:true},
    },
    ready:function(){
      this.getCards();  
    },
    getCards:function(){
      var refSelect;
      var self = this;
      self.sortedArray=[];
      for(var card of this.cardsKudo){
        var _basicCard=card;
        _basicCard.qtyKudo=0;
        self.push('sortedArray',_basicCard);
      }
      if(this.withExclusiveKudo){
        refSelect = firebase.database().ref(this.activeEvent + "/logExclusiveKudos/" + this.idKudo);
        refSelect.once('value').then(function(snapshot) {
          snapshot.forEach(function(child) {
            self.sortedArray.find(function(currentValue, index, arr) {
              if(currentValue.idCard === child.val()){
                currentValue.qtyKudo++;
              }
            });
          });
          self.sortedArray.sort(self.compareValues('qtyKudo','desc'));
          var ranking=self.$$('#ranking_' +self.idKudo);
          ranking.render();
        });
      }else{
        refSelect = firebase.database().ref(this.activeEvent + "/logKudos/" + idCard + "/" + idKudo +"/" + this.userEmail);

      }
    },
    compareValues:function(key, order='asc') {
      return function(a, b) {
        if(!a.hasOwnProperty(key) || 
           !b.hasOwnProperty(key)) {
      	  return 0; 
        }
        
        const varA = (typeof a[key] === 'string') ? 
          a[key].toUpperCase() : a[key];
        const varB = (typeof b[key] === 'string') ? 
          b[key].toUpperCase() : b[key];
          
        let comparison = 0;
        if (varA > varB) {
          comparison = 1;
        } else if (varA < varB) {
          comparison = -1;
        }
        return (
          (order == 'desc') ? 
          (comparison * -1) : comparison
        );
      };
    },
    unCollapseTable: function(e) {
      if(e.target.dataSelector!='undefined'){
        this.$$(e.target.dataSelector).toggle();
        var blockKudoStat=this.$$('#blockKudoStat_' +this.idKudo);
        if(blockKudoStat.opened){
          this.getCards();  
        }
      }
      
    }
  });
</script>
</dom-module>
