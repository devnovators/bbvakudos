<dom-module id="kudos-award-table">
<link rel="import" href="../css/kudo-style.html">
<template>
    <style include="about-estilo"></style>
    <style include="cards"></style>
    <paper-card class="paper_card_summary">
      <div class="rate-header titleProject" style="background-color:#facc61;" on-click="unCollapseTable" data-selector="#blockKudoAwardStat">
          <div class="display_inline kudo_base" style='margin-top:10px;background-image: url(../images/hack.png);margin-top: 5px;'  data-selector="#blockKudoAwardStat"></div>
          <div class="display_inline" width="70%" style="top: 40%;transform: translateY(-90%);font-weight:bolder;color:#fff!important;" data-selector="#blockKudoAwardStat">
            Ranking 
          </div>
      </div>

      <iron-collapse id="blockKudoAwardStat" style="width:100%;">
        <div id="table_award"></div>
      </iron-collapse>
    </paper-card>
</template>

<script>
 Polymer({
    is: 'kudos-award-table',
    properties: {
      activeEvent       : { type: String,   notify:true},
      cardsKudo         : { type: Array,    value:[],     notify:true},
      sortedArray       : { type: Array,    notify:true},
      kudosAward        : { type: Array,    value:[],     notify:true},
    },
    ready:function(){
      this.getCardsKudosAward();  
    },
    getCardsKudosAward:function(){
      var self = this;
      self.sortedArray=[];
      for(var card of this.cardsKudo){ 
        var _basicCard=card;
        _basicCard.kudosAward=[];
        for(var index of this.kudosAward){
          var kudoAward=this.kudosAward[index];
          kudoAward.id=index;
          kudoAward.qtyVotes=0;
          kudoAward.qtyJury=0;
          _basicCard.kudosAward.push(kudoAward);
        }
        _basicCard.total=0;
        console.info(_basicCard);
        self.push('sortedArray',_basicCard);
      }
      this.getRankingKudosAward();
    },
    getRankingKudosAward:function(){
      var refSelect;
      var self = this;
      refSelect = firebase.database().ref(this.activeEvent + "/logKudosAward");
      refSelect.once('value').then(function(snapshot) {
        snapshot.forEach(function(child) {
          self.sortedArray.find(function(currentValue, index, arr) {
            if(currentValue.idCard === child.key){
              console.info('project found!');
              console.info(child.val());
              var _kudosAward=child.val();
              for (var idKudo in _kudosAward) {
                currentValue.kudosAward.find(function(_currentValue, _index, _arr) {
                  if(_currentValue.id==_kudosAward[idKudo]){
                    console.info('**encontrado**');
                  }
                });
                //kudosAward
              }
              currentValue.total++;
            }
          });
        });
        self.sortedArray.sort(self.compareValues('total','desc'));
        self.createTable();
      });
    },
    compareValues:function(key, order='asc') {
      return function(a, b) {
        if(!a.hasOwnProperty(key) || 
           !b.hasOwnProperty(key)) {
      	  return 0; 
        }
        
        const varA = (typeof a[key] === 'string') ? 
          a[key].toUpperCase() : a[key];
        const varB = (typeof b[key] === 'string') ? 
          b[key].toUpperCase() : b[key];
          
        let comparison = 0;
        if (varA > varB) {
          comparison = 1;
        } else if (varA < varB) {
          comparison = -1;
        }
        return (
          (order == 'desc') ? 
          (comparison * -1) : comparison
        );
      };
    },
    closeTable:function(){
      var blockKudoStat=this.$$('#blockKudoAwardStat');
      if(blockKudoStat.opened){
        blockKudoStat.toggle();
      }
    },
    unCollapseTable: function(e) {
      if(e.target.dataSelector!='undefined'){
        this.$$(e.target.dataSelector).toggle();
        var blockKudoStat=this.$$('#blockKudoAwardStat');
        if(blockKudoStat.opened){
          this.getRankingKudosAward();  
        }
      }
    },
    createTable:function(){
      var item="";
      var head_start='';
      var head_mid='';
      var head_end='';
      var head_col_ini='';
      var head_col_fin='';
      
      head_start = '<div class="row_table_bottom"><div class="row_table_cup"><img src="../images/values_cup.jpg" /></div><div class="row_table_qty">';
      head_col_ini='<div class="row_table_qty">';
      head_col_fin='</div>';
      head_mid   = '</div><div class="row_table_detail">';
      head_end   = '</div></div></div>';
      this.$$('#table_award').innerHTML="";
      
      for(var card of this.sortedArray){
        //console.info('Item: '+ card.title);
        //console.info('| perJury==> ' + card.perJury +'| qtyJury==> ' + card.qtyJury);
        //console.info('| perKudo==> ' + card.perKudo +'| qtyKudo==> ' + card.qtyKudo);
        item=head_start + card.total + '%' + head_mid + card.titleBlock +" &gt " + card.title + head_end;
        this.$$('#table_award').innerHTML=this.$$('#table_award').innerHTML+item;
      }
    },
  });
</script>
</dom-module>
